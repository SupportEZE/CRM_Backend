name: Build, Scan, and Deploy

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: "Enter 'scan' for code scan or 'deploy' for deployment"
        required: true
      folder_name:
        description: "Folder Name (Required for deploy)"
        required: false

jobs:
  conditional-job:
    runs-on: ubuntu-latest
    steps:
      - name: â³ Check Inputs
        id: check
        run: |
          echo "Action Type: ${{ github.event.inputs.action_type }}"
          
          if [[ "${{ github.event.inputs.action_type }}" == "deploy" ]]; then
            if [[ -z "${{ github.event.inputs.folder_name }}" ]]; then
              echo "âŒ folder_name is required for deployment."
              exit 1
            fi
          fi
          echo "âœ… Input validation passed."

  validate-client-folder:
    needs: conditional-job
    if: ${{ github.event.inputs.action_type == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš« Validate client folder exists on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 43.204.204.109
          username: ec2-user
          port: 22786
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            FOLDER_NAME="${{ github.event.inputs.folder_name }}"
            if [ ! -d "/var/www/html/$FOLDER_NAME" ]; then
              echo "âŒ ERROR: Client folder '/var/www/html/$FOLDER_NAME' does not exist."
              exit 1
            else
              echo "âœ… BACKEND folder exists."
            fi

  scan-job:
    needs: conditional-job
    if: ${{ github.event.inputs.action_type == 'scan' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ§¹ Clean up macOS-only deps
        run: |
          jq 'del(.dependencies["@rollup/rollup-darwin-arm64"])' package.json > temp.json && mv temp.json package.json
          sed -i '/"@rollup\/rollup-darwin-arm64"/,+5d' package-lock.json
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --legacy-peer-deps
          npm install sortablejs flatpickr apexcharts filepond luxon overlayscrollbars --save
          npm install @types/sortablejs @types/flatpickr @types/luxon --save-dev || true
          
      - name: ğŸ” Run SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner.zip
          export PATH="$PWD/sonar-scanner-5.0.1.3006-linux/bin:$PATH"
          sonar-scanner \
            -Dsonar.projectKey=CRM-Tailwind \
            -Dsonar.sources=src \
            -Dsonar.host.url=http://13.203.181.169:9000 \
            -Dsonar.login=$SONAR_TOKEN

      - name: ğŸ›¡ï¸ Run Bearer scan
        run: |
          curl -sSLo bearer.tar.gz https://github.com/Bearer/bearer/releases/download/v1.49.0/bearer_1.49.0_linux_amd64.tar.gz
          tar -xzf bearer.tar.gz
          chmod +x bearer
          ./bearer scan . --format sarif --output bearer-report.sarif || true

      - name: ğŸ“¤ Upload Bearer Report
        uses: actions/upload-artifact@v4
        with:
          name: bearer-report
          path: bearer-report.sarif

      - name: ğŸ“§ Email scan reports
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Code Scan Reports - Sonar & Bearer
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.EMAIL_FROM }}
          secure: false
          attachments: bearer-report.sarif
          body: |
            Hello,

            Code Quality and Security scan has been done. Please check the reports:
            - Sonar: http://13.203.181.169:9000/dashboard?id=CRM-Tailwind
            - Bearer: Attached.

            Regards,
            CI/CD Bot

  deploy-job:
    needs: validate-client-folder
    if: ${{ github.event.inputs.action_type == 'deploy' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install dependencies (no lock file fallback)
        run: npm install

      - name: ğŸ› ï¸ Build Angular app
        run: npm run build -- --output-path=preview

      - name: ğŸ“¦ Zip build
        run: zip -r build.zip dist/

      - name: â˜ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: angular-build
          path: build.zip

      - name: ğŸ“¦ Copy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 43.204.204.109
          username: ec2-user
          port: 22786
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: build.zip
          target: /home/ec2-user/backend

      - name: ğŸš€ Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 43.204.204.109
          username: ec2-user
          port: 22786
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            FOLDER_NAME="${{ github.event.inputs.client_name }}"
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            BACKUP_DIR="/home/ec2-user/${FOLDER_NAME}/dist_backup_$TIMESTAMP"

            echo "ğŸ“ Backing up existing deployment to $BACKUP_DIR ..."
            if [ -d "/var/www/html/$FOLDER_NAME" ]; then
              cp -r /var/www/html/$FOLDER_NAME "$BACKUP_DIR"
              echo "âœ… Backup complete."
            else
              echo "âš ï¸ Warning: No existing folder to backup."
            fi

            echo "ğŸ“¦ Unzipping new build and deploying..."
            cd /home/ec2-user/backend
            unzip -o build.zip
            cp -r dist/* /var/www/html/$FOLDER_NAME/dist
            echo "ğŸš€ Deployment complete."
